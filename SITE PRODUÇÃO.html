<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard Produção</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .chart-container { width: 600px; margin-bottom: 40px; }
</style>
</head>
<body>
<h1>Dashboard Produção - Colchões</h1>

<div class="chart-container">
  <h2>DADOS - MONTAGEM E COLAGEM</h2>
  <canvas id="chartMontagem"></canvas>
</div>

<div class="chart-container">
  <h2>RESULTADO FAIXA - BOX</h2>
  <canvas id="chartBox"></canvas>
</div>

<div class="chart-container">
  <h2>RESULTADO FAIXA - MOLAS E COLCHOES</h2>
  <canvas id="chartMolas"></canvas>
</div>

<div class="chart-container">
  <h2>RESULTADO FAIXA - MESA COSTURA</h2>
  <canvas id="chartMesaCostura"></canvas>
</div>

<div class="chart-container">
  <h2>RESULTADO ORTOPEDICO</h2>
  <canvas id="chartOrtopedico"></canvas>
</div>

<script>
const spreadsheetBaseUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfWQjxYbB4YwwlUBX-o_uTqw-nY6-mX2P3I0oBijFnn3meRsTr1ndWFQJrRH3zRx7EbJqLIYyfNZtN/gviz/tq?tqx=out:json&sheet=";

const sheets = [
  {name: "DADOS - MONTAGEM E COLAGEM", canvasId: "chartMontagem"},
  {name: "RESULTADO FAIXA - BOX", canvasId: "chartBox"},
  {name: "RESULTADO FAIXA - MOLAS E COLCHOES", canvasId: "chartMolas"},
  {name: "RESULTADO FAIXA - MESA COSTURA", canvasId: "chartMesaCostura"},
  {name: "RESULTADO ORTOPEDICO", canvasId: "chartOrtopedico"}
];

// Variável para guardar os gráficos para atualizar depois
let charts = {};

function fetchSheetData(sheetName) {
  const encodedSheet = encodeURIComponent(sheetName);
  const url = spreadsheetBaseUrl + encodedSheet;

  return fetch(url)
    .then(response => response.text())
    .then(text => {
      // O retorno é JSONP, precisa extrair o JSON
      const jsonText = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
      return JSON.parse(jsonText);
    });
}

function processMontagemData(data) {
  // Montar dataset: soma quantidade por Montador Principal
  const rows = data.table.rows;
  const map = new Map();

  rows.forEach(row => {
    const montador = row.c[2]?.v || "Indefinido";
    const qtd = row.c[4]?.v || 0;
    map.set(montador, (map.get(montador) || 0) + qtd);
  });

  return {
    labels: [...map.keys()],
    values: [...map.values()]
  };
}

function processFaixaBoxData(data) {
  // Soma quantidade por Costureira
  const rows = data.table.rows;
  const map = new Map();

  rows.forEach(row => {
    const costureira = row.c[1]?.v || "Indefinido";
    const qtd = row.c[3]?.v || 0;
    map.set(costureira, (map.get(costureira) || 0) + qtd);
  });

  return {
    labels: [...map.keys()],
    values: [...map.values()]
  };
}

function processFaixaMolasData(data) {
  // Soma quantidade por Costureira
  const rows = data.table.rows;
  const map = new Map();

  rows.forEach(row => {
    const costureira = row.c[1]?.v || "Indefinido";
    const qtd = row.c[3]?.v || 0;
    map.set(costureira, (map.get(costureira) || 0) + qtd);
  });

  return {
    labels: [...map.keys()],
    values: [...map.values()]
  };
}

function processMesaCosturaData(data) {
  // Soma quantidade por Costureira
  const rows = data.table.rows;
  const map = new Map();

  rows.forEach(row => {
    const costureira = row.c[1]?.v || "Indefinido";
    const qtd = row.c[3]?.v || 0;
    map.set(costureira, (map.get(costureira) || 0) + qtd);
  });

  return {
    labels: [...map.keys()],
    values: [...map.values()]
  };
}

function processOrtopedicoData(data) {
  // Soma quantidade por Montador
  const rows = data.table.rows;
  const map = new Map();

  rows.forEach(row => {
    const montador = row.c[1]?.v || "Indefinido";
    const qtd = row.c[3]?.v || 0;
    map.set(montador, (map.get(montador) || 0) + qtd);
  });

  return {
    labels: [...map.keys()],
    values: [...map.values()]
  };
}

function createChart(ctx, labels, values, title) {
  if (charts[ctx.id]) {
    charts[ctx.id].data.labels = labels;
    charts[ctx.id].data.datasets[0].data = values;
    charts[ctx.id].update();
    return charts[ctx.id];
  }

  const newChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Quantidade',
        data: values,
        backgroundColor: 'rgba(54, 162, 235, 0.7)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: title,
          font: { size: 18 }
        },
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision:0 }
        }
      }
    }
  });
  charts[ctx.id] = newChart;
  return newChart;
}

async function loadCharts() {
  try {
    // DADOS - MONTAGEM E COLAGEM
    const montagemData = await fetchSheetData("DADOS - MONTAGEM E COLAGEM");
    const montagemProcessed = processMontagemData(montagemData);
    createChart(document.getElementById("chartMontagem").getContext("2d"), montagemProcessed.labels, montagemProcessed.values, "Montagem e Colagem");

    // RESULTADO FAIXA - BOX
    const boxData = await fetchSheetData("RESULTADO FAIXA - BOX");
    const boxProcessed = processFaixaBoxData(boxData);
    createChart(document.getElementById("chartBox").getContext("2d"), boxProcessed.labels, boxProcessed.values, "Faixa - Box");

    // RESULTADO FAIXA - MOLAS E COLCHOES
    const molasData = await fetchSheetData("RESULTADO FAIXA - MOLAS E COLCHOES");
    const molasProcessed = processFaixaMolasData(molasData);
    createChart(document.getElementById("chartMolas").getContext("2d"), molasProcessed.labels, molasProcessed.values, "Faixa - Molas e Colchões");

    // RESULTADO FAIXA - MESA COSTURA
    const mesaData = await fetchSheetData("RESULTADO FAIXA - MESA COSTURA");
    const mesaProcessed = processMesaCosturaData(mesaData);
    createChart(document.getElementById("chartMesaCostura").getContext("2d"), mesaProcessed.labels, mesaProcessed.values, "Faixa - Mesa Costura");

    // RESULTADO ORTOPEDICO
    const ortopedicoData = await fetchSheetData("RESULTADO ORTOPEDICO");
    const ortopedicoProcessed = processOrtopedicoData(ortopedicoData);
    createChart(document.getElementById("chartOrtopedico").getContext("2d"), ortopedicoProcessed.labels, ortopedicoProcessed.values, "Resultado Ortopédico");

  } catch (error) {
    console.error("Erro ao carregar os dados:", error);
  }
}

// Inicializa a carga
loadCharts();

// Atualiza a cada 5 minutos (300000 ms)
setInterval(loadCharts, 300000);

</script>
</body>
</html>
